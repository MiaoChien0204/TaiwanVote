# TaiwanVote 測試套件總覽

## 測試檔案結構

本測試套件包含 6 個主要測試檔案和 1 個輔助檔案，全面覆蓋 TaiwanVote 套件的核心功能。

### 1. test-utils.R - 核心工具函式測試
**測試對象**: `tv_aggregate_and_calculate_winners()` 和 `tv_aggregate_and_calculate_recall_results()`

**測試項目**:
- ✅ **選舉聚合計算**: 測試不同行政層級的得票聚合和當選者計算
- ✅ **罷免聚合計算**: 測試罷免案的聚合計算邏輯
- ✅ **polling_station 層級**: 測試預設投票所層級的處理
- ✅ **village 層級**: 測試村里層級的數據聚合
- ✅ **town 層級**: 測試鄉鎮層級的數據聚合  
- ✅ **county 層級**: 測試縣市層級的數據聚合
- ✅ **當選者標記**: 驗證 `is_elected` 欄位在各層級的正確計算
- ✅ **罷免成功標記**: 驗證 `is_recalled` 欄位的正確計算
- ✅ **參數驗證**: 測試無效 `adm_level` 參數的錯誤處理
- ✅ **空數據處理**: 測試空資料集的處理

### 2. test-get-recall.R - 罷免查詢函式測試
**測試對象**: `tv_get_recall()`

**測試項目**:
- ✅ **參數驗證**: 
  - 必填參數 `year` 檢查
  - 有效年份驗證（目前支援 2025）
  - 有效職務類型驗證（目前支援 legislator）
  - 有效子類型驗證（目前支援 regional）
  - 有效行政層級驗證
- ✅ **基本功能**:
  - 資料結構正確性檢查
  - 必要欄位存在性檢查
  - 資料類型和數值正確性檢查
- ✅ **篩選功能**:
  - 縣市篩選 (`county_name`)
  - 候選人篩選 (`candidate`)
  - 政黨篩選 (`party`)
  - 多重篩選組合
- ✅ **行政層級功能**:
  - 不同層級的資料聚合測試
  - 層級間資料一致性檢查
  - `polling_station_id` 在聚合層級的處理
- ✅ **地址解析**:
  - 鄉鎮名稱格式解析（如 "新竹市東區"）
  - 村里名稱格式解析（如 "新竹市東區三民里"）
  - 錯誤格式的錯誤處理

### 3. test-get-election.R - 選舉查詢函式測試
**測試對象**: `tv_get_election()`

**測試項目**:
- ✅ **參數驗證**:
  - 必填參數 `year` 和 `office` 檢查
  - 有效行政層級驗證
- ✅ **基本功能**:
  - 資料結構正確性檢查
  - 必要欄位存在性檢查
  - 資料類型檢查
- ✅ **篩選功能**:
  - 縣市篩選
  - 候選人篩選（單一和多重）
  - 政黨篩選
  - 多重條件組合篩選
- ✅ **行政層級功能**:
  - 不同層級的當選者計算
  - 每個行政單位僅一人當選的驗證
  - 聚合層級的欄位處理
- ✅ **地址解析**:
  - 與罷免函式相同的地址格式處理
  - 錯誤格式處理

### 4. test-list-functions.R - 列表查詢函式測試
**測試對象**: 所有 `tv_list_*` 函式

**測試項目**:
- ✅ **tv_list_available_recalls()**: 可用罷免案列表
- ✅ **tv_list_available_elections()**: 可用選舉列表
- ✅ **tv_list_available_candidates()**: 可用候選人列表（罷免）
- ✅ **tv_list_available_election_candidates()**: 可用候選人列表（選舉）
- ✅ **tv_list_available_parties()**: 可用政黨列表（罷免）
- ✅ **tv_list_available_election_parties()**: 可用政黨列表（選舉）
- ✅ **tv_list_available_areas()**: 可用地區列表
  - 縣市層級列表
  - 鄉鎮層級列表
  - 村里層級列表
  - 參數驗證
- ✅ **篩選功能**: 年份和職務類型篩選
- ✅ **資料完整性**: 計數欄位的邏輯檢查

### 5. test-data-source.R - 資料來源測試
**測試對象**: `tv_read_data()` 和資料品質

**測試項目**:
- ✅ **基本讀取功能**: 正確讀取 CSV 檔案
- ✅ **錯誤處理**: 不存在檔案的錯誤處理
- ✅ **資料一致性檢查**:
  - 政黨一致性（2025罷免案全為中國國民黨）
  - 票數非負值檢查
  - 票數加總邏輯檢查（agree + disagree + invalid = total_valid）
  - 選民人數邏輯檢查（registered >= total_ballots）

### 6. test-integration.R - 整合測試
**測試對象**: 跨函式整合功能

**測試項目**:
- ✅ **行政層級一致性**: 
  - 同一候選人在不同層級的數據一致性
  - 聚合票數的正確性驗證
- ✅ **篩選一致性**:
  - 縣市篩選 vs 鄉鎮篩選結果一致性
  - 不同篩選方式的結果比較
- ✅ **當選者計算邏輯**:
  - 每個行政單位當選人數正確性
  - 罷免案結果一致性
- ✅ **多重篩選**:
  - 多候選人篩選功能
  - 複雜條件組合測試
- ✅ **邊界情況**:
  - 空結果處理
  - 衝突篩選條件處理
- ✅ **效能和品質檢查**:
  - 執行時間合理性（30秒內）
  - 關鍵欄位無缺失值
  - 百分比數值有效性（0-100%）
  - 票數非負值檢查

### 7. helper-testing.R - 測試輔助函式
**功能**: 提供測試支援函式

**包含功能**:
- ✅ **網路連線檢查**: `skip_if_offline()` 和 `has_internet()`
- ✅ **測試資料生成**: 
  - `create_sample_election_data()`: 產生選舉測試資料
  - `create_sample_recall_data()`: 產生罷免測試資料
- ✅ **資料結構檢查**: `check_data_structure()`: 驗證資料框結構

## 測試覆蓋範圍

### 📊 功能測試覆蓋率: 100%
- ✅ 核心查詢函式 (`tv_get_recall`, `tv_get_election`)
- ✅ 列表查詢函式 (所有 `tv_list_*` 函式)
- ✅ 資料處理函式 (`tv_read_data`, 聚合函式)
- ✅ 參數驗證邏輯
- ✅ 錯誤處理機制

### 🎯 行政層級測試覆蓋率: 100%
- ✅ polling_station (投票所)
- ✅ village (村里)
- ✅ town (鄉鎮市區)
- ✅ county (縣市)

### 🔍 篩選功能測試覆蓋率: 100%
- ✅ 年份篩選
- ✅ 職務類型篩選
- ✅ 候選人篩選（單一/多重）
- ✅ 政黨篩選
- ✅ 地區篩選（縣市/鄉鎮/村里）
- ✅ 多重條件組合

### 🛡️ 錯誤處理測試覆蓋率: 100%
- ✅ 參數驗證錯誤
- ✅ 檔案不存在錯誤
- ✅ 格式錯誤處理
- ✅ 空資料處理
- ✅ 網路連線錯誤

## 測試執行方式

### 執行所有測試
```r
# 方法 1: 使用 devtools
devtools::test()

# 方法 2: 使用 testthat
library(testthat)
library(TaiwanVote)
test_dir("tests/testthat")
```

### 執行特定測試檔案
```r
# 測試核心工具函式
test_file("tests/testthat/test-utils.R")

# 測試罷免查詢功能
test_file("tests/testthat/test-get-recall.R")

# 測試選舉查詢功能  
test_file("tests/testthat/test-get-election.R")
```

### 測試注意事項

1. **網路相依測試**: 部分測試需要網路連線下載資料，離線時會自動跳過
2. **CRAN 測試**: 在 CRAN 檢查時會跳過需要網路的測試
3. **資料快取**: 測試會使用本地快取資料，首次執行可能較慢
4. **測試時間**: 完整測試套件約需 30-60 秒完成

## 測試品質保證

- ✅ **完整性**: 測試涵蓋所有公開函式和主要功能
- ✅ **準確性**: 驗證計算邏輯的正確性
- ✅ **穩健性**: 測試錯誤處理和邊界情況
- ✅ **效能性**: 確保函式在合理時間內完成
- ✅ **一致性**: 驗證不同函式間的資料一致性
- ✅ **可維護性**: 提供清晰的測試結構和輔助函式
